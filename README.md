Crear un CD autoinstal·lable
================================

Opcio 1 : Kickstart
-------------
Fer servir kickstart (de Red Hat) sembla que és la forma més senzilla de fer-ho. 

De totes formes no té totes les opcions que té el Debian Installer de Ubuntu i per tant s'ha de recórrer a respondre algunes de les preguntes amb un fitxer *preseed*

La idea és respondre les preguntes que farà l'instal·lador a partir del programa gràfic per aconseguir respondre les respostes habituals i afegir respostes 'personalitzades' a partir d'un fitxer *pressed*

### Procediment per crear el CD

#### 1. Aconseguir els fitxers

Es parteix d'un CD amb Ubuntu Server (sembla que els LiveCD tenen problemes) i es munta

    # mkdir -p /mnt/iso
    #  mount -o loop ubuntu.iso /mnt/iso

Ara es copien els arxius que fan falta en una carpeta temporal:

    # mkdir -p /opt/ubuntuiso 
    # cp -rt /mnt/iso /opt/ubuntuiso

#### 2. Generar les respostes

Es genera el fitxer de respostes Kickstart a partir del programa system-config-kickstart que està en la distribució d'Ubuntu: 

    # apt-get install system-config-kickstart
    # system-config-kickstart

Proporcionarà un entorn gràfic per preparar les respostes. Algunes de les respostes es poden ignorar perquè no estan activades en Ubuntu (configurar entorn gràfic, autenticació LDAP, etc.. ) i d'altres no donen tantes possibilitats (particionat de disc, ...)

![system-config-kickstart](imatges/ks.png)

I es graven les respostes en un fitxer. Per exemple *ks.cfg*

El que he fet jo té aquesta forma: 

    #Generated by Kickstart Configurator
    #platform=AMD64 or Intel EM64T

    #System language
    lang ca_ES.UTF-8

    #Language modules to install
    langsupport ca_ES.UTF-8

    #System keyboard
    keyboard es_cat

    #System mouse
    mouse

    #System timezone
    timezone Europe/Madrid

    #Root password
    rootpw --disabled

    #Initial user
    user usuari --fullname "Usuari" --iscrypted --password $1$q1377fKR$sgQw7R1KzxC6drQurGVhm1

    #Reboot after installation
    reboot

    #Use text mode install
    text
    #Install OS instead of upgrade
    install

    #Use CDROM installation media
    cdrom

    #System bootloader configuration
    bootloader --location=mbr 

    #Clear the Master Boot Record
    zerombr yes

    #Partition clearing information
    clearpart --all --initlabel 

    #System authorization infomation
    auth  --useshadow  --enablemd5 

    #Firewall configuration
    firewall --disabled 

    #Do not configure the X Window System
    skipx

Al final s'hi poden afegir paquets 'extres' a instal·lar durant la instal·lació: 

    # Paquets a instal·lar
    %packages
    @ xubuntu-desktop
    openssh-server
    screen

L'instal·lador d'Ubuntu fa unes quantes preguntes més que no es poden respondre amb Kickstart. Per fer-ho es genera un arxiu *pressed*, en aquest exemple **ks.preseed** (algunes respostes pot ser que no calguin perquè he estat fent proves...)

    d-i preseed/early_command string umount /media
    d-i partman/unmount_active boolean true
    d-i partman/confirm_write_new_label boolean true
    d-i partman/choose_partition \
    select Finish partitioning and write changes to disk
    d-i partman/confirm boolean true

    d-i pkgsel/include string xubuntu-desktop

Aquests arxius s'han de copiar a l'arrel del CD: 

    # cp ks.cfg /opt/ubuntuiso
    # cp ks.preseed /opt/ubuntuiso

#### 3. Modificar la configuració

Per evitar que s'aturi esperant que triem l'idioma d'instal·lació es pot modificar el valor de *timeout* al fitxer isolinux/isolinux.cfg (10 és un segon): 

    # cat /opt/ubuntuiso/isolinux/isolinux.cfg
    path 
    include menu.cfg
    default vesamenu.c32
    prompt 0
    timeout 10
    ui gfxboot bootlogo

I per acabar la configuració s'ha de modificar la opció del menú d'arrancada perquè agafi els fitxers KickStart (modificant la opció append): 

    label install
    menu label ^Install Ubuntu Server
    kernel /install/vmlinuz
    append file=/cdrom/preseed/ubuntu-server.seed initrd=/install/initrd.gz ks=cdrom:/ks.cfg preseed/file=/cdrom/ks.preseed --

Com que el fitxer està dins del CD hi he posat **ks=cdrom:/ks.cfg**. El fitxer no cal que sigui dins del CD ja que es pot proporcionar amb qualsevol dels mètodes habituals http, ftp, o nfs

#### 4. Generar la ISO 
Només queda generar la ISO: 

    # mkisofs -D -r -V "ATTENDLESS_UBUNTU" -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o /opt/autoinstall.iso /opt/ubuntuiso

